
 #####									  #####
##### Script Extender Scoped Event Targets #####
 #####									  #####
 # Scoped event target effects do not have a static or assumed value of effects on the stack but change depending on the effect being called
 # Used for creating event targets accessible only from a specific scope
 # Scoped event targets are not restricted to one as a global or to the nested effects of an event call but instead are only accessible from a specific scope

### Creates a scope exclusive event target
### Parameters
# target_owner - the scope to register the event target too
# event_target_name - unique event target name
### Effect takes 2 effect calls on the effect call stack
### Access return value by scope event_target:se_return_value
se_save_scoped_event_target = {
	save_global_event_target_as = se_point_to_scope
	if = {
		limit = { is_scope_set = event_target:$target_owner$ }	
		event_target:$target_owner$ = {
			if = {
				limit = { exists = event_target:se_point_from_scope }
				clear_global_event_target = se_point_from_scope
			}
			save_global_event_target_as = se_point_from_scope
		}
	}
	else_if = {
		limit = { is_scope_set = $target_owner$ }
		$target_owner$ = {
			if = {
				limit = { exists = event_target:se_point_from_scope }
				clear_global_event_target = se_point_from_scope
			}
			save_global_event_target_as = se_point_from_scope
		}
	}
	else = {
		log_error = "se_save_scoped_event_target: Invalid scope reference passed by argument: target_owner"
		break = yes
	}
	se_clear_return_target = yes
	se_get_database = { bound_to = se_point_from_scope }
	if = {
		limit = { NOT = { exists = event_target:se_return_value } }
		se_create_database = { bind_to_scope = se_point_from_scope }
		event_target:se_return_value = {
			if = {
				limit = { exists = event_target:se_point_from_scope }
				clear_global_event_target = se_point_from_scope
			}
			save_global_event_target_as = se_point_from_scope
		}
	}
	else = {
		event_target:se_return_value = {
			if = {
				limit = { exists = event_target:se_point_from_scope }
				clear_global_event_target = se_point_from_scope
			}
			save_global_event_target_as = se_point_from_scope
		}
		se_clear_return_target = yes
	}
	event_target:se_scoped_event_target_owner_database = {
		se_create_database_entry = {
			identifier = $event_target_name$
			overwrite = yes
		}
		event_target:se_return_value = {
			set_leader_flag = se_points_to_@event_target:se_point_to_scope
			se_set_database_entry_flag = { flag = se_scoped_event_target }
			event_target:se_point_to_scope = {
				switch = {
					trigger = is_scope_type
					default = {}
					country = { prev = { se_set_database_entry_flag = { flag = se_country_scope } } }
					sector = {
						prev = {
							se_set_database_entry_flag = { flag = se_sector_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					galactic_object = { prev = { se_set_database_entry_flag = { flag = se_system_scope } } }
					megastructure = {
						prev = {
							se_set_database_entry_flag = { flag = se_megastructure_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.planet }
							se_set_database_entry_flag = { flag = se_planet_owner }
							se_set_database_entry_flag = { flag = se_requires_initial_search }
							se_set_database_entry_flag = { flag = se_initial_system_search }
							se_set_database_entry_flag = { flag = se_initial_search_for_@event_target:se_point_to_scope.planet.solar_system }
						}
					}
					ambient_object = {
						prev = {
							se_set_database_entry_flag = { flag = se_ambient_object_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.solar_system }
							se_set_database_entry_flag = { flag = se_system_owner }
						}
					}
					planet = {
						prev = {
							se_set_database_entry_flag = { flag = se_planet_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.solar_system }
							se_set_database_entry_flag = { flag = se_system_owner }
						}
					}
					deposit = {
						prev = {
							se_set_database_entry_flag = { flag = se_deposit_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.planet }
							se_set_database_entry_flag = { flag = se_planet_owner }
							se_set_database_entry_flag = { flag = se_requires_initial_search }
							se_set_database_entry_flag = { flag = se_initial_system_search }
							se_set_database_entry_flag = { flag = se_initial_search_for_@event_target:se_point_to_scope.planet.solar_system }
						}
					}
					archeaological_site = {
						prev = {
							se_set_database_entry_flag = { flag = se_archeaological_site_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.planet }
							se_set_database_entry_flag = { flag = se_planet_owner }
							se_set_database_entry_flag = { flag = se_requires_initial_search }
							se_set_database_entry_flag = { flag = se_initial_system_search }
							se_set_database_entry_flag = { flag = se_initial_search_for_@event_target:se_point_to_scope.planet.solar_system }
						}
					}
					army = {
						prev = {
							se_set_database_entry_flag = { flag = se_army_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					pop = {
						prev = {
							se_set_database_entry_flag = { flag = se_pop_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.planet }
							se_set_database_entry_flag = { flag = se_planet_owner }
							se_set_database_entry_flag = { flag = se_requires_initial_search }
							se_set_database_entry_flag = { flag = se_initial_system_search }
							se_set_database_entry_flag = { flag = se_initial_search_for_@event_target:se_point_to_scope.planet.solar_system }
						}
					}
					species = { prev = { se_set_database_entry_flag = { flag = se_species_scope } } }
					leader = {
						prev = {
							se_set_database_entry_flag = { flag = se_leader_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					pop_faction = {
						prev = {
							se_set_database_entry_flag = { flag = se_faction_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					ship = {
						prev = {
							se_set_database_entry_flag = { flag = se_ship_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					fleet = {
						prev = {
							se_set_database_entry_flag = { flag = se_fleet_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					federation = { prev = { se_set_database_entry_flag = { flag = se_federation_scope } } }
					war = { prev = { se_set_database_entry_flag = { flag = se_war_scope } } }
					first_contact = {
						prev = {
							se_set_database_entry_flag = { flag = se_first_contact_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					spynetwork = {
						prev = {
							se_set_database_entry_flag = { flag = se_spy_network_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
					starbase = {
						prev = {
							se_set_database_entry_flag = { flag = se_starbase_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.solar_system }
							se_set_database_entry_flag = { flag = se_system_owner }
						}
					}
					espionage_operation = {
						prev = {
							se_set_database_entry_flag = { flag = se_espionage_operation_scope }
							se_set_database_entry_flag = { flag = se_has_owner }
							se_set_database_entry_flag = { flag = se_owner_@event_target:se_point_to_scope.owner }
							se_set_database_entry_flag = { flag = se_country_owner }
						}
					}
				}
			}
		}
	}
	if = {
		limit = { exists = event_target:se_point_to_scope }
		clear_global_event_target = se_point_to_scope
	}
	if = {
		limit = { exists = event_target:se_point_from_scope }
		clear_global_event_target = se_point_from_scope
	}
	if = {
		limit = { exists = event_target:se_scoped_event_target_owner_database }
		clear_global_event_target = se_scoped_event_target_owner_database
	}
}

### Retrieves a scope exclusive event target
### Parameters
# event_target_name - unique event target name
### Effect takes 3 effect calls on the effect call stack
se_get_scoped_event_target_value = {
	se_clear_return_target = yes
	if = {
		limit = { se_is_database = yes }
		se_set_return_target = yes
	}
	else = { se_get_database = { bound_to = this } }
	if = {
		limit = { exists = event_target:se_return_value }
		event_target:se_return_value = {
			if = {
				limit = { exists = event_target:se_hidden_database_target }
				clear_global_event_target = se_hidden_database_target
			}
			save_global_event_target_as = se_hidden_database_target
		}
		se_clear_return_target = yes
		event_target:se_hidden_database_target = {
			se_get_database_entry = { identifier = $event_target_name$ }
			if = {
				limit = {
					exists = event_target:se_return_value
					event_target:se_return_value = { has_leader_flag = se_scoped_event_target }
				}
				event_target:se_return_value = {
					if = {
						limit = { exists = event_target:se_hidden_scope_pointer }
						clear_global_event_target = se_hidden_scope_pointer
					}
					save_global_event_target_as = se_hidden_scope_pointer
				}
				se_clear_return_target = yes
				event_target:se_hidden_scope_pointer = {
					if = {
						limit = { has_leader_flag = se_requires_initial_search }
						switch = {
							trigger = has_leader_flag
							se_initial_system_search = {
								random_system = {
									limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_initial_search_for_@prev } }
									if = {
										limit = { exists = event_target:se_initial_search_scope }
										clear_global_event_target = se_initial_search_scope
									}
									save_global_event_target_as = se_initial_search_scope
								}
							}
						}
						event_target:se_initial_search_scope = { se_internal_get_owner_scope = yes }
						clear_global_event_target = se_initial_search_scope
					}
					else = { se_internal_get_owner_scope = yes }
				}
				if = {
					limit = { exists = event_target:se_return_value }
					event_target:se_return_value = { save_event_target_as = $event_target_name$ }
					se_clear_return_target = yes
				}
				else = { event_target:se_hidden_database_target = { se_remove_database_entry = { identifier = $event_target_name$ } } }
			}
			else = { log_error = "se_get_scoped_event_target_value: Scope this does not have a valid event target with the given identifier." }
		}
	}
	else = { log_error = "se_get_scoped_event_target_value: Scope this is not a database and does not have an obviously accessable database." }
	if = {
		limit = { exists = event_target:se_hidden_database_target }
		clear_global_event_target = se_hidden_database_target
	}
	if = {
		limit = { exists = event_target:se_hidden_scope_pointer }
		clear_global_event_target = se_hidden_scope_pointer
	}
}
### Internal use, do not use outside of code within this mod
se_internal_get_owner_scope = {
	event_target:se_hidden_scope_pointer = {
		if = {
			limit = { has_leader_flag = se_has_owner }
			switch = {
				trigger = has_leader_flag
				se_country_owner = {
					prev = {
						random_country = {
							limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_owner_@prev } }
							if = {
								limit = { exists = event_target:se_owner_search_scope }
								clear_global_event_target = se_owner_search_scope
							}
							save_global_event_target_as = se_owner_search_scope
						}
					}
				}
				se_planet_owner = {
					prev = {
						random_system_planet = {
							limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_owner_@prev } }
							if = {
								limit = { exists = event_target:se_owner_search_scope }
								clear_global_event_target = se_owner_search_scope
							}
							save_global_event_target_as = se_owner_search_scope
						}
					}
				}
				se_system_owner = {
					prev = {
						random_system = {
							limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_owner_@prev } }
							if = {
								limit = { exists = event_target:se_owner_search_scope }
								clear_global_event_target = se_owner_search_scope
							}
							save_global_event_target_as = se_owner_search_scope
						}
					}
				}
			}
			if = {
				limit = { exists = event_target:se_owner_search_scope }
				event_target:se_owner_search_scope = { se_internal_grab_event_target_scope = yes }
				clear_global_event_target = se_owner_search_scope
			}
		}
		else = { se_internal_grab_event_target_scope = yes }
	}
}
### Internal use, do not use outside of code within this mod
se_internal_grab_event_target_scope = {
	event_target:se_hidden_scope_pointer = {
		switch = {
			trigger = has_leader_flag
			se_espionage_operation_scope = {
				prev = {
					every_espionage_operation = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_starbase_scope = {
				prev = {
					if = {
						limit = { exists = starbase }
						starbase = {
							if = {
								limit = { event_target:se_point_from_scope = { has_leader_flag = se_points_to_@prev } }
								if = {
									limit = { exists = event_target:se_return_value }
									clear_global_event_target = se_return_value
								}
								save_global_event_target_as = se_return_value
							}
						}
					}
				}
			}
			se_spy_network_scope = {
				prev = {
					every_spynetwork = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_first_contact_scope = {
				prev = {
					every_first_contact = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_war_scope = {
				prev = {
					random_war = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_federation_scope = {
				prev = {
					random_federation = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_species_scope = {
				prev = {
					random_galaxy_species = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_country_scope = {
				prev = {
					random_country = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_system_scope = {
				prev = {
					random_system = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_fleet_scope = {
				prev = {
					random_owned_fleet = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_ship_scope = {
				prev = {
					random_owned_ship = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_faction_scope = {
				prev = {
					random_pop_faction = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_leader_scope = {
				prev = {
					random_owned_leader = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
					if = {
						limit = { NOT = { exists = event_target:se_return_value } }
						random_pool_leader = {
							limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
							if = {
								limit = { exists = event_target:se_return_value }
								clear_global_event_target = se_return_value
							}
							save_global_event_target_as = se_return_value
						}
					}
				}
			}
			se_pop_scope = {
				prev = {
					random_owned_pop = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_army_scope = {
				prev = {
					random_owned_army = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_archeaological_site_scope = {
				prev = {
					if = {
						limit = { exists = archaeological_site }
						archaeological_site = {
							if = {
								limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
								if = {
									limit = { exists = event_target:se_return_value }
									clear_global_event_target = se_return_value
								}
								save_global_event_target_as = se_return_value
							}
						}
					}
				}
			}
			se_deposit_scope = {
				prev = {
					random_deposit = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_planet_scope = {
				prev = {
					random_system_planet = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_ambient_object_scope = {
				prev = {
					random_system_ambient_object = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
			se_megastructure_scope = {
				prev = {
					if = {
						limit = { exists = megastructure }
						megastructure = {
							if = {
								limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
								if = {
									limit = { exists = event_target:se_return_value }
									clear_global_event_target = se_return_value
								}
								save_global_event_target_as = se_return_value
							}
						}
					}
				}
			}
			se_sector_scope = {
				prev = {
					random_owned_sector = {
						limit = { event_target:se_hidden_scope_pointer = { has_leader_flag = se_points_to_@prev } }
						if = {
							limit = { exists = event_target:se_return_value }
							clear_global_event_target = se_return_value
						}
						save_global_event_target_as = se_return_value
					}
				}
			}
		}
	}
}

### Deletes a scope exclusive event target
### Parameters
# event_target_name - unique event target name
se_delete_scoped_event_target = {
	se_clear_return_target = yes
	if = {
		limit = { se_is_database = yes }
		if = {
			limit = { exists = event_target:se_hidden_database_target }
			clear_global_event_target = se_hidden_database_target
		}
		save_global_event_target_as = se_hidden_database_target
	}
	else = {
		se_get_database = { bound_to = this }
		if = {
			limit = { exists = event_target:se_return_value }
			event_target:se_return_value = {
				if = {
					limit = { exists = event_target:se_hidden_database_target }
					clear_global_event_target = se_hidden_database_target
				}
				save_global_event_target_as = se_hidden_database_target
			}
			se_clear_return_target = yes
		}
		else = { log_error = "se_delete_scoped_event_target: Scope this is not a database and does not have an obviously accessable database" }
	}
	event_target:se_hidden_database_target = { se_remove_database_entry = { identifier = $event_target_name$ } }
	se_clear_return_target = yes
}

 #####					   	   #####
##### Script Extender Databases #####
 #####					   	   #####
 # All database effects should be assumed to take 1 effect call on the effect call stack
 # Databases are used for the storage and collection of specific data, mainly required for a specific scope
 # For best compatibility, databases should not be interacted with behind the scenes beyond the specific Script Extender provided triggers and effect

### Creates a database object
### Parameters
# identifier(optional)		- A global unique identifier to make retrieving the database easier(useful mainly for global databases)
# bind_to_scope(optional)	- A scope object to lock database access to, default value is this
### Access return value by scope - event_target:se_last_created_database or event_target:se_return_value
se_create_database = {
	[[bind_to_scope]
	if = {
		limit = { is_scope_set = event_target:$bind_to_scope$ }
		event_target:$bind_to_scope$ = { save_global_event_target_as = se_hidden_db_owner }
	}
	else_if = {
		limit = { is_scope_set = $bind_to_scope$ }
		$bind_to_scope$ = { save_global_event_target_as = se_hidden_db_owner }
	}
	else = {
		log_error = "se_create_database: Invalid scope reference passed by argument: bind_to_scope"
		break = yes
	}
	if = {
		limit = { exists = event_target:se_hidden_db_owner }
	]
		create_country = {
			type = se_country_database
			effect = {
				[[bind_to_scope]
				if = {
					limit = { exists = event_target:se_hidden_db_owner }
						set_country_flag = se_bound_to_object_@event_target:se_hidden_db_owner
						set_name = se_database_bound_name						
				}
				else_]if = {
					limit = { exists = event_target:se_global_database }
					set_name = se_database_unbound_name
				}
				else = { set_name = se_database_backup_name }
				[[identifier]set_country_flag = $identifier$]
				set_variable = {
					which = se_database_entry_count
					value = 0
				}
				set_country_flag = se_country_database
				if = {
					limit = { exists = event_target:se_last_created_database }
					clear_global_event_target = se_last_created_database
				}
				save_global_event_target_as = se_last_created_database
				if = {
					limit = { exists = event_target:se_return_value }
					clear_global_event_target = se_return_value
				}
				save_global_event_target_as = se_return_value
			}
		}
		[[bind_to_scope]
		if = {
			limit = { exists = event_target:se_hidden_db_owner }
			clear_global_event_target = se_hidden_db_owner
		}
		]
	}
}

### Deletes a specific database from the game
### Parameters
# database(optional) - A direct scope to a database declaration(will be verified before deletion)
# bound_to(optional) - The database(if any) assigned the parameter object
### If none of these are written the effect will use the calling scope to determine
se_delete_database = {
	[[database]
	if = {
		limit = { is_scope_set = $database$ }
		$database$ = { save_global_event_target_as = se_database_to_delete }
	}
	else_if = {
		limit = { is_scope_set = event_target:$database$ }
		event_target:$database$ = { save_global_event_target_as = se_database_to_delete }
	}
	else = { log_error = "se_delete_database: The provided scope is not a database entry: database" }
	if = {
		limit = { exists = event_target:se_database_to_delete }
		event_target:se_database_to_delete = {
			if = {
				limit = {
					is_scope_type = country
					is_country_type = se_country_database
				}
				every_owned_leader = {
					kill_leader = {
						fire = yes
						show_notification = no
					}
				}
				every_owned_fleet = { delete_fleet = this }
				destroy_country = yes
				set_global_flag = se_delete_performed
			}
			else = { log_error = "se_delete_database: The provided scope is not a database entry: database" }
		}
	}
	]
	[[bound_to]
	if = {
		limit = { NOT = { has_global_flag = se_delete_performed } }
		if = {
			limit = { exists = $bound_to$ }
			$bound_to$ = { save_global_event_target_as = se_hidden_database_to_delete_owner }
		}
		else_if = {
			limit = { exists = event_target:$bound_to$ }
			event_target:$bound_to$ = { save_global_event_target_as = se_hidden_database_to_delete_owner }
		}
		else = { log_error = "se_delete_database: Invalid scope reference passed by argument: bound_to" }
		if = {
			limit = { exists = event_target:se_hidden_database_to_delete_owner }
			random_country = {
				limit = {
					is_scope_type = country
					is_country_type = se_country_database
					has_country_flag = se_bound_to_object_@event_target:se_hidden_database_to_delete_owner
				}
				every_owned_leader = {
					kill_leader = {
						fire = yes
						show_notification = no
					}
				}
				every_owned_fleet = { delete_fleet = this }
				destroy_country = yes
			}
			set_global_flag = se_delete_performed
		}
	}
	
	if = {
		limit = { NOT = { has_global_flag = se_delete_performed } }
		if = {
			limit = {
				is_scope_type = country
				is_country_type = se_country_database
			}
			every_owned_leader = {
				kill_leader = {
					fire = yes
					show_notification = no
				}
			}
			every_owned_fleet = { delete_fleet = this }
			destroy_country = yes
		}
		else = {
			random_country = {
				limit = {
					is_scope_type = country
					is_country_type = se_country_database
					has_country_flag = se_bound_to_object_@this
				}
				every_owned_leader = {
					kill_leader = {
						fire = yes
						show_notification = no
					}
				}
				every_owned_fleet = { delete_fleet = this }
				destroy_country = yes
			}
		}
	}
	else = { remove_global_flag = se_delete_performed }
	[[database]
	if = {
		limit = { exists = event_target:se_database_to_delete }
		clear_global_event_target = se_database_to_delete
	}
	]
	[[bound_to]
	if = {
		limit = { exists = event_target:se_hidden_database_to_delete_owner }
		clear_global_event_target = se_hidden_database_to_delete_owner
	}
	]
}

### Retrieves a database object
### Parameters
# bound_to(optional) - The database(if any) assigned the parameter object
# identifier(optional) - Unique identifier to single out which database to select
### Access return value by scope event_target:se_return_value
se_get_database = {
	[[bound_to]
		set_global_flag = se_optional_parameter_set
		if = {
			limit = { is_scope_set = $bound_to$ }
			$bound_to$ = { save_global_event_target_as = se_hidden_db_target }
		}
		else_if = {
			limit = { is_scope_set = event_target:$bound_to$ }
			event_target:$bound_to$ = { save_global_event_target_as = se_hidden_db_target }
		}
	]
	[[identifier]set_global_flag = se_optional_parameter_set]
	if = {
		limit = { has_global_flag = se_optional_parameter_set }
		if = {
			limit = { exists = event_target:se_return_value }
			clear_global_event_target = se_return_value
		}
		random_country = {
			limit = {
				is_scope_type = country
				is_country_type = se_country_database
				[[bound_to]
				AND = {
					exists = event_target:se_hidden_db_target
					has_country_flag = se_bound_to_object_@event_target:se_hidden_db_target
				}
				]
				[[identifier]has_country_flag = $identifier$]
			}
			if = {
				limit = { exists = event_target:se_return_value }
				clear_global_event_target = se_return_value
			}
			save_global_event_target_as = se_return_value
		}
		remove_global_flag = se_optional_parameter_set
	}
	else = { log_error = "se_get_database: A parameter was required but not given, to properly function  one of the parameters bound_to or identifier are required to be inputed." }
	[[bound_to]
		if = {
			limit = { exists = event_target:se_hidden_db_target }
			clear_global_event_target = se_hidden_db_target
		}
	]
}

### Sets a flag to a database(accessed by se_get_database)
### Parameters
# flag - the flag to be added to the database
# days(optional) 	- 	days for the flag to expire
# months(optional) 	- 	months for the flag to expire
# years(optional)	-	years for the flag to expire
### If none of the optional parameters are added, the flag will remain until removed
se_set_database_flag = {
	if = {
		limit = {
			is_scope_type = country
			is_country_type = se_country_database
		}
		[[days]
			set_variable = {
				which = se_database_days_value
				value = $days$
			}
		]
		[[months]
			set_variable = {
				which = se_database_months_value
				value = $months$
			}
		]
		[[years]
			set_variable = {
				which = se_database_years_value
				value = $years$
			}
		]
		if = {
			limit = {
				OR = {
					[[days]
						check_variable = {
							which = se_database_days_value
							value = $days$
						}
					]
					[[months]
						check_variable = {
							which = se_database_months_value
							value = $months$
						}
					]
					[[years]
						check_variable = {
							which = se_database_years_value
							value = $years$
						}
					]
					always = no
				}
			}
			[[days]clear_variable = se_database_days_value]
			[[months]clear_variable = se_database_months_value]
			[[years]clear_variable = se_database_years_value]
			set_timed_country_flag = {
				flag = $flag$
				days = $days|0$
				[[months]months = $months$]
				[[years]years = $years$]
			}
		}
		else = { set_country_flag = $flag$ }
	}
	else = { log_error = "se_set_database_flag: The provided scope is not a database entry:" }
}

### Removes a flag to a database(accessed by se_get_database)
### Parameters
# flag - the flag to be removed from the database
se_remove_database_flag = {
	if = {
		limit = {
			is_scope_type = country
			is_country_type = se_country_database
		}
		remove_country_flag = $flag$
	}
	else = { log_error = "se_remove_database_flag: The provided scope is not a database entry:" }
}

### Creates a new database entry
### Requires to be in the scope of a database(use se_get_database to get the database reference)
### Parameters
# identifier - A unique identifier for the entry, will not create a new entry if an entry with this identifier already exists
# name(optional) - The name of the database entry
# overwrite(optional) - Whether to delete the existing database entry if it finds one
### Access return value by scope event_target:se_return_value
se_create_database_entry = {
	if = {
		limit = { exists = event_target:se_return_value }
		clear_global_event_target = se_return_value
	}
	if = {
		limit = {
			is_scope_type = country
			is_country_type = se_country_database
		}
		random_owned_leader = {
			limit = {
				is_scope_type = leader
				exists = owner
				owner = { is_scope_type = country }
				has_leader_flag = se_database_entry
				has_leader_flag = $identifier$
			}
			if ={
				limit = { always = $overwrite|no$ }
				kill_leader = {
					fire = yes
					show_notification = no
				}
			}
			else = {
				if = {
					limit = { exists = event_target:se_return_value }
					clear_global_event_target = se_return_value
				}
				save_global_event_target_as = se_return_value
			}
		}
		if = {
			limit = { NOT = { exists = event_target:se_return_value } }
			change_variable = {
				which = se_database_entry_count
				value = 1
			}
			create_leader = {
				name = $name|se_empty_database_entry$
				class = governor
				species = event_target:se_database_entry_species
				traits = {}
				immortal = yes
				effect = {
					set_leader_flag = $identifier$
					set_leader_flag = se_database_entry
					if = {
						limit = { exists = event_target:se_return_value }
						clear_global_event_target = se_return_value
					}
					save_global_event_target_as = se_return_value
				}
			}
		}
	}
	else = { log_error = "se_create_database_entry: The provided scope is not a database entry:" }
}

### Removes an entry from the database
### Requires to be the in the scope of the database(use se_get_database to get the database reference)
### Parameters
# identifier - a unique identifier for the entry
se_remove_database_entry = {
	if = {
		limit = {
			is_scope_type = country
			is_country_type = se_country_database
		}
		random_owned_leader = {
			limit = {
				is_scope_type = leader
				exists = owner
				owner = { is_scope_type = country }
				has_leader_flag = se_database_entry
				has_leader_flag = $identifier$
			}
			owner = { se_decrement = { variable = se_database_entry_count } }
			kill_leader = {
				fire = yes
				show_notification = no
			}
		}
	}
	else = { log_error = "se_remove_database_entry: The provided scope is not a database entry:" }
}

### Retrieves an entry from a database
### Requires to be in the scope of a database(use se_get_database to get the database reference)
### Parameters
# identifier - A unique identifier to the entry that needs to be found
### Access return value by scope event_target:se_return_value
se_get_database_entry = {
	if = {
		limit = {
			is_scope_type = country
			is_country_type = se_country_database
		}
		random_owned_leader = {
			limit = {
				is_scope_type = leader
				exists = owner
				owner = { is_scope_type = country }
				has_leader_flag = se_database_entry
				has_leader_flag = $identifier$
			}
			se_set_return_target = yes
		}
	}
	else = { log_error = "se_get_database_entry: The provided scope is not a database entry:" }
}

### Adds a flag to a database entry
### Requires to be in the scope of a database entry(use se_get_database_entry to get the reference)
### Parameters
# flag - the flag to add to the entry
# days(optional) 	- 	days for the flag to expire
# months(optional) 	- 	months for the flag to expire
# years(optional)	-	years for the flag to expire
### If none of the optional parameters are added, the flag will remain until removed
se_set_database_entry_flag = {
	if = {
		limit = {
			is_scope_type = leader
			exists = owner
			owner = { is_scope_type = country }
			has_leader_flag = se_database_entry
		}
		[[days]
			set_variable = {
				which = se_entry_days_value
				value = $days$
			}
		]
		[[months]
			set_variable = {
				which = se_entry_months_value
				value = $months$
			}
		]
		[[years]
			set_variable = {
				which = se_entry_years_value
				value = $years$
			}
		]
		if = {
			limit = {
				OR = {
					[[days]
						check_variable = {
							which = se_entry_days_value
							value = $days$
						}
					]
					[[months]
						check_variable = {
							which = se_entry_months_value
							value = $months$
						}
					]
					[[years]
						check_variable = {
							which = se_entry_years_value
							value = $years$
						}
					]
					always = no
				}
			}
			[[days]clear_variable = se_entry_days_value]
			[[months]clear_variable = se_entry_months_value]
			[[years]clear_variable = se_entry_years_value]
			set_timed_leader_flag = {
				flag = $flag$
				days = $days|0$
				[[months]months = $months$]
				[[years]years = $years$]
			}
		}
		else = { set_leader_flag = $flag$ }
		
	}
	else = { log_error = "se_add_database_entry_flag: The provided scope is not a database entry:" }
}

### Removes a flag to a database entry
### Requires to be in the scope of a database entry(use se_get_database_entry to get the reference)
### Parameters
# flag - the flag to be removed from the entry
se_remove_database_entry_flag = {
	if = {
		limit = {
			is_scope_type = leader
			exists = owner
			owner = { is_scope_type = country }
			has_leader_flag = se_database_entry
		}
		remove_leader_flag = $flag$
	}
	else = { log_error = "se_remove_database_entry_flag: The provided scope is not a database entry:" }
}

 #####							#####
##### Database Extension Effects #####
 #####							#####
 # Assume all extension effects below take 2 effect calls on the effect stack
 # Not distinct in their own right, merely pieces the above database effects together to create situational and convient data

### Retrieves the database for the executing scope or returns the global database
### Access return value by scope event_target:se_return_value
se_get_scope_or_global_database = {
	se_clear_return_target = yes
	se_get_database = { bound_to = this }
	if = {
		limit = { NOT = { exists = event_target:se_return_value } }
		event_target:se_global_database = { save_global_event_target_as = se_return_value }
	}
}

### Retrieves the existing database and creates one if it does not exist
### Parameters
# identifier(optional)	- The unique identifier of this database, used for global databases
# bound_to(optional)	- The scope this database is bound to, used for scope specific variables
### Access return value by scope event_target:se_return_value
se_get_or_create_database = {
	[[identifier]set_global_flag = se_param_one_activated]
	[[bound_to]set_global_flag = se_param_two_activated]
	if = {
		limit = {
			NOR = {
				has_global_flag = se_param_one_activated
				has_global_flag = se_param_two_activated
			}
		}
		log_error = "se_get_or_create_database: Neither parameters identifier or bound_to are fulfilled, a database lacking both parameters cannot be managed or found once all scopes point away from it."
		break = yes
	}
	else = {
		remove_global_flag = se_param_one_activated
		remove_global_flag = se_param_two_activated
	}
	[[bound_to]
		if = {
			limit = { is_scope_set = $bound_to$ }
			save_global_event_target_as = se_hidden_database_owner_scope
		}
		else_if = {
			limit = { is_scope_set = event_target:$bound_to$ }
			save_global_event_target_as = se_hidden_database_owner_scope
		}
		else = {
			log_error = "se_get_or_create_database: Invalid scope reference passed by argument: bound_to"
			break = yes
		}
	]
	se_clear_return_target = yes
	se_get_database = {
		[[identifier]identifier = $identifier$]
		[[bound_to] = event_target:se_hidden_database_owner_scope]
	}
	if = {
		limit = { NOT = { exists = event_target:se_return_value } }
		event_target:se_hidden_database_owner_scope = {
			se_create_database = {
				[[identifier]identifier = $identifier$]
				[[bound_to]bind_to_scope = event_target:se_hidden_database_owner_scope]
			}
		}
	}
}

### Overwrites or just creates a new database if one does not already exists
### Parameters
# identifier(optional)	- The unique identifier of this database, used for global databases
# bound_to(optional)	- The scope this database is bound to, used for scope specific variables
### Access return value by scope event_target:se_return_value
se_overwrite_database = {
	[[identifier]set_global_flag = se_param_one_activated]
	[[bound_to]set_global_flag = se_param_two_activated]
	if = {
		limit = {
			NOR = {
				has_global_flag = se_param_one_activated
				has_global_flag = se_param_two_activated
			}
		}
		log_error = "se_get_or_create_database: Neither parameters identifier or bound_to are fulfilled, a database lacking both parameters cannot be managed or found once all scopes point away from it."
		break = yes
	}
	else = {
		remove_global_flag = se_param_one_activated
		remove_global_flag = se_param_two_activated
	}
	[[bound_to]
		if = {
			limit = { is_scope_set = $bound_to$ }
			save_global_event_target_as = se_hidden_database_owner_scope
		}
		else_if = {
			limit = { is_scope_set = event_target:$bound_to$ }
			save_global_event_target_as = se_hidden_database_owner_scope
		}
		else = {
			log_error = "se_get_or_create_database: Invalid scope reference passed by argument: bound_to"
			break = yes
		}
	]
	se_clear_return_target = yes
	se_get_database = {
		[[identifier]identifier = $identifier$]
		[[bound_to] = event_target:se_hidden_database_owner_scope]
	}
	if = {
		limit = { exists = event_target:se_return_value }
		event_target:se_return_value = { se_delete_database = { database = this } }
	}
	se_create_database = {
		[[identifier]identifier = $identifier$]
		[[bound_to]bind_to_scope = event_target:se_hidden_database_owner_scope]
	}
}